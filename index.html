import streamlit as st
import pandas as pd
from sleeper_wrapper import League, Players

st.set_page_config(layout="wide", page_title="BTM: 16-Team War Room")

@st.cache_data(ttl=86400)
def get_all_players():
    return Players().get_all_players()

# Weights adjusted for a 22-starter league aiming for ~265 Total Points
STRICT_WEIGHTS = {
    "QB": 19, "RB": 15, "WR": 16, "TE": 11, "FLEX": 13, "SUPER_FLEX": 19,
    "K": 8, "DEF": 8, "DL": 9, "LB": 14, "DB": 10, "IDP_FLEX": 12
}

def get_surgical_benchmarks(league_details):
    # HARD FIX: We set the weekly goal to exactly 265 PPG (Your 250-275 range)
    win_threshold = 265.0 
    
    slots = league_details.get('roster_positions', [])
    total_w = sum([STRICT_WEIGHTS.get(s, 10) for s in slots])
    
    benchmarks = {}
    for s in set(slots):
        count = slots.count(s)
        # Normalize the 265pt goal across your 22 starters
        benchmarks[s] = round((STRICT_WEIGHTS.get(s, 10) * count / total_w) * win_threshold, 1)
    
    return benchmarks, win_threshold

with st.sidebar:
    st.write("### ğŸ“¡ War Room Connection")
    l_id = st.text_input("Sleeper League ID", "1180557728257867776")
    curr_week = st.number_input("Current Week", 1, 18, 1)
    
    if st.button("Sync War Room"):
        st.session_state.current_week = curr_week
        league = League(l_id)
        rosters, users, l_details = league.get_rosters(), league.get_users(), league.get_league()
        u_map = {u['user_id']: u['display_name'] for u in users}
        
        processed = []
        for r in rosters:
            owner = u_map.get(r['owner_id'], "Unknown")
            # CRITICAL FIX: Divide season-long PF by current week to get ACTUAL PPG
            actual_ppg = r['settings'].get('fpts', 0) / max(curr_week, 1)
            
            slots = l_details.get('roster_positions', [])
            total_w = sum([STRICT_WEIGHTS.get(s, 10) for s in slots])
            
            # Map that PPG back to position groups
            pos_scores = {s: round(actual_ppg * (STRICT_WEIGHTS.get(s, 10) * slots.count(s) / total_w), 1) 
                          for s in set(slots)}
            
            processed.append({"Owner": owner, "PPG": actual_ppg, "Scores": pos_scores, "Roster": r['players']})
        
        st.session_state.df = pd.DataFrame(processed)
        st.session_state.league_details = l_details
        st.session_state.all_players = get_all_players()

if "df" in st.session_state:
    benchmarks, goal = get_surgical_benchmarks(st.session_state.league_details)
    st.title("ğŸ›¡ï¸ 16-Team Internal Roster Audit")
    st.metric("Championship Target", f"{goal} PPG", help="Hard-coded to your league's 250-275 baseline")
    
    target_owner = st.selectbox("Select Team", st.session_state.df['Owner'])
    owner_data = st.session_state.df[st.session_state.df['Owner'] == target_owner].iloc[0]
    
    audit_list = []
    for pos, target in benchmarks.items():
        actual = owner_data['Scores'].get(pos, 0)
        diff = actual - target
        
        # Color coding: 10% threshold for deep leagues
        status = "ğŸ’ SURPLUS" if diff > (target * 0.1) else "âŒ GAP" if diff < -(target * 0.1) else "âš–ï¸ SOLID"
        
        players = [st.session_state.all_players.get(str(pid), {}).get('full_name', 'Unknown') 
                   for pid in owner_data['Roster'] if st.session_state.all_players.get(str(pid), {}).get('position') == pos]

        audit_list.append({"Position": pos, "Target": target, "Actual": actual, "Status": status, "Players": ", ".join(players)})

    def style_status(row):
        color = "#00CC96" if "SURPLUS" in row.Status else "#EF553B" if "GAP" in row.Status else "#636EFA"
        return [f'background-color: {color}; color: white'] * len(row)

    st.dataframe(pd.DataFrame(audit_list).style.apply(style_status, axis=1), use_container_width=True, hide_index=True)
